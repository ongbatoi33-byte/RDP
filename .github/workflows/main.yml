name: RDP-Web-Browser

on:
  workflow_dispatch:

jobs:
  web-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Cau hinh Windows RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force

      - name: Tao nguoi dung RDP
        run: |
          $password = "Oibanoi874@"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"

      - name: Cai dat Myrtille (Web Gateway)
        run: |
          # Myrtille cho phép truy cập RDP qua trình duyệt (HTML5)
          Invoke-WebRequest -Uri "https://github.com/cedrozane/myrtille/releases/download/v2.9.1/Myrtille_2.9.1_x86_x64.msi" -OutFile "myrtille.msi"
          Start-Process msiexec.exe -ArgumentList "/i", "myrtille.msi", "/quiet", "/norestart" -Wait

      - name: Mo luong Web qua Serveo
        shell: cmd
        run: |
          # Forward cong 80 (Web RDP) ra ngoai qua Serveo
          start /b ssh -o StrictHostKeyChecking=no -R 80:localhost:80 serveo.net > web_rdp.log 2>&1

      - name: Lay link truy cap Web
        run: |
          Write-Host "Dang tao link truy cap Web RDP..."
          Start-Sleep -Seconds 30
          $log = Get-Content web_rdp.log -Raw
          
          if ($log -match "https://[a-zA-Z0-9-.]+\.serveo\.net") {
              $webUrl = $matches[0]
              Write-Host "`n========================================" -ForegroundColor Green
              Write-Host "TRUY CAP RDP QUA TRINH DUYET" -ForegroundColor Green
              Write-Host "Link: $webUrl/Myrtille" -ForegroundColor Cyan
              Write-Host "User: RDP" -ForegroundColor Cyan
              Write-Host "Pass: Oibanoi874@" -ForegroundColor Cyan
              Write-Host "----------------------------------------"
              Write-Host "Luu y: Mo link tren bang Chrome/Safari."
              Write-Host "========================================`n"
          } else {
              Write-Error "Khong tao duoc link Web. Hay thu lai."
          }

      - name: Duy tri
        run: |
          while ($true) { Start-Sleep -Seconds 300 }
