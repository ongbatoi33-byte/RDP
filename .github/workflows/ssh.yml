name: Tailscale SSH Fixed
on: workflow_dispatch

jobs:
  ssh-access:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: Setup SSH No Password
        run: |
          # 1. Thêm flag --reset để sửa lỗi "non-default flags"
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --ssh --hostname=github-runner --reset
          
          # 2. Xóa mật khẩu của user runner
          sudo passwd -d runner
          
          # 3. Cấu hình SSH cho phép pass trống (Dùng lệnh sudo tee để ghi file an toàn hơn)
          echo "PermitEmptyPasswords yes" | sudo tee -a /etc/ssh/sshd_config
          echo "UsePAM no" | sudo tee -a /etc/ssh/sshd_config
          
          # 4. Khởi động lại SSH
          sudo systemctl restart ssh

          echo "================================================"
          echo "IP: $(tailscale ip -4)"
          echo "Lệnh kết nối: ssh runner@$(tailscale ip -4)"
          echo "================================================"

      - name: Keep Alive
        run: sleep 3600
