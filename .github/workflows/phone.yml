name: Android Cloud Phone Azure-Fix
on: workflow_dispatch

jobs:
  cloud-phone:
    runs-on: ubuntu-latest
    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}
          args: --ssh --hostname=cloud-phone

      - name: Install Docker and Setup
        run: |
          # Gỡ xung đột và cài Docker sạch
          sudo apt-get remove -y containerd.io containerd runc
          sudo apt-get update
          sudo apt-get install -y docker.io
          
          # Không dùng modprobe vì Kernel Azure không hỗ trợ trực tiếp
          # Chúng ta sẽ ép Redroid sử dụng bộ nhớ mô phỏng

      - name: Launch Redroid (Special Config for Azure)
        run: |
          # Dùng mode privileged và các tham số ép buộc để Android tự khởi tạo bộ nhớ
          sudo docker run -d -p 5555:5555 \
            --name redroid11 \
            --privileged \
            redroid/redroid:11.0.0-latest \
            androidboot.redroid_width=720 \
            androidboot.redroid_height=1280 \
            androidboot.redroid_dpi=320 \
            androidboot.redroid_fps=30 \
            redroid.gpu.mode=guest \
            redroid.behold=1

      - name: Setup Web-ADB Control
        run: |
          # Chạy giao diện Web trên cổng 80
          sudo docker run -d -p 80:80 \
            --name web-adb \
            yumechan/ya-webadb:latest

          echo "================================================"
          echo "Android đang khởi chạy trên Kernel Azure..."
          echo "IP: $(tailscale ip -4)"
          echo "Hãy đợi 2-3 phút để Android boot xong rồi mới truy cập."
          echo "================================================"

      - name: Keep Alive
        run: sleep 21600
