name: Android Cloud Phone Final-Fix
on: workflow_dispatch

jobs:
  cloud-phone:
    runs-on: ubuntu-latest
    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}
          args: --ssh --hostname=cloud-phone

      - name: Install Docker
        run: |
          sudo apt-get remove -y containerd.io containerd runc
          sudo apt-get update
          sudo apt-get install -y docker.io

      - name: Launch Redroid (Android 11)
        run: |
          sudo docker run -d -p 5555:5555 \
            --name redroid11 \
            --privileged \
            redroid/redroid:11.0.0-latest \
            androidboot.redroid_width=720 \
            androidboot.redroid_height=1280 \
            androidboot.redroid_dpi=320 \
            redroid.gpu.mode=guest

      - name: Setup Web Control (New Image)
        run: |
          # Sử dụng ws-scrcpy: Đây là bản xịn nhất để điều khiển Android qua trình duyệt
          # Nó cho phép bạn thấy màn hình chạy thời gian thực (real-time)
          sudo docker run -d -p 80:8000 \
            --name cloud-controller \
            --link redroid11:android \
            -e ADB_SERVER_IP=android \
            -e ADB_SERVER_PORT=5555 \
            sandreas/ws-scrcpy:latest

          echo "================================================"
          echo "Android đang khởi động..."
          echo "Địa chỉ Cloud Phone: http://$(tailscale ip -4)"
          echo "================================================"

      - name: Keep Alive
        run: sleep 21600
